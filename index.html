<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lecture des texte - ÿßÿ≥ÿ™ŸÖÿßÿπ Ÿà ŸÇÿ±ÿßÿ°ÿ©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-padding-top: 40vh; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; direction: ltr; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .page-content-wrapper { width: 100%; max-width: 900px; position: relative; z-index: 1; }
        h1.surah-title { font-size: 2.5em; color: white; margin-top: 15px; margin-bottom: 25px; text-align: center; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        #modeSelector, #listenModeUI, #translationModeUI, #memorizeModeUI, #syllableModeUI, #sentence { background: rgba(255, 255, 255, 0.92); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        #modeSelector { display: flex; justify-content: center; gap: 10px; padding: 25px; flex-wrap: wrap; }
        .mode-select-button { color: white; border: none; padding: 10px 20px; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); min-width: 130px; text-align: center; margin: 5px; }
        #btnSelectListen { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #btnSelectTranslation { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        #btnSelectSyllable { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); } 
        #btnSelectMemorize { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .mode-select-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); }
        .mode-select-button.active { background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%) !important; box-shadow: inset 0 3px 7px rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.2); transform: translateY(1px); }
        .reader-select-group { margin-bottom: 15px; text-align: center; }
        .lesson-title-display { text-align: center; font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #d1e9ff; }
        #listenModeUI select, #translationModeUI select, #syllableModeUI select { font-size: 1em; padding: 10px; width:100%; max-width: 300px; border-radius: 8px; border: 1px solid #ddd; background-color: white; margin: 0 auto; }
        #sentence { font-size: clamp(20px, 5.5vw, 30px); line-height: 1.8; text-align: left; padding-top: 15px; } 
        .word-wrapper { display: inline-flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 8px 5px; margin: 0 2px; border-radius: 5px; vertical-align: bottom; transition: all 0.2s ease-in-out; cursor: pointer; position: relative; min-height: 3em; }
        .word-wrapper .translation-text { display: none; font-family: Arial, sans-serif; font-size: 0.5em; color: red; line-height: 1.2; text-align: center; direction: ltr; margin-bottom: 4px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: normal; max-height: 2.4em; }
        .page-translation-mode-active .word-wrapper .translation-text { display: block; }
        .word-wrapper .arabic-word { display: block; text-align: center; } 
        .ayah-number { color: #667eea; font-size: 0.75em; margin: 0 5px; display: inline-block; vertical-align: bottom; line-height: 3em; visibility: visible !important; }
        .highlight-active-word { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; color: #fff !important; transform: scale(1.05); box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3); visibility: visible !important; opacity: 1 !important; }
        .highlight-active-word .arabic-word { color: #fff !important; }
        .highlight-active-word .translation-text { color: #ffeb3b !important; font-weight: bold; } 
        .processed-word { background: rgba(79, 172, 254, 0.15) !important; color: #333 !important; transform: none; visibility: visible !important; opacity: 1 !important; }
        .processed-word .arabic-word { color: #333 !important; }
        .processed-word .translation-text { color: darkred !important; }
        .memorize-sentence-placeholder.memorize-mode-active .word-wrapper.highlight-active-word { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important; color: #000 !important; box-shadow: 0 2px 10px rgba(67, 233, 123, 0.3); }
        .memorize-sentence-placeholder.memorize-mode-active .word-wrapper.highlight-active-word .arabic-word { color: #000 !important; }
        .memorize-sentence-placeholder.memorize-mode-active .word-wrapper.processed-word { background: rgba(67, 233, 123, 0.15) !important; }
        .memorize-sentence-placeholder.memorize-mode-active .word-wrapper.processed-word .arabic-word { color: #333 !important; }
        .memorize-sentence-placeholder.memorize-mode-active .word-wrapper:not(.highlight-active-word):not(.processed-word) { visibility: visible !important; opacity: 0.7; }
        .correct-sign { position: absolute; top: 0px; right: -5px; color: #28a745; font-weight: bold; font-size: 0.8em; line-height: 1; z-index: 5; pointer-events: none; background: white; border-radius: 50%; padding: 1px 3px; }
        .processed-word .correct-sign { visibility: visible !important; opacity: 1 !important; }
        .controls { margin-top: 15px; margin-bottom: 10px; display: flex; justify-content: center; gap:15px; }
        .controls button { border: none; padding: 12px 22px; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); min-width: 130px; text-align:center; color: white; }
        #listenControls button, #translationControls button, #memorizeControls button:not(#resetButtonMemorize), #syllableNavControls button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #memorizeControls #resetButtonMemorize { background: linear-gradient(135deg, #868e96 0%, #595f65 100%); }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .controls button:active { transform: translateY(0px); }
        #memorizeControls #speechButtonMemorize.listening { background: linear-gradient(135deg, #ff6b6b 0%, #f06595 100%) !important; animation: none !important; }
        #listenControls #playPauseButtonListen, #translationControls #playPauseButtonTranslation { font-size: 1.3em; padding: 10px 20px; }
        #memorizeTimerDisplay { font-size: 2em; font-weight: bold; color: #333; margin-bottom: 10px; font-family: Arial, sans-serif;}
        #memorizeControls { margin-bottom:10px; } 
        #showFirstWordToggleDiv { margin-bottom: 15px; font-family: Arial, sans-serif; text-align:center; }
        #speechStatusMemorize { font-size: 1.6em; padding: 10px 15px; border-radius: 10px; min-height: 2.5em; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; line-height: 1.4; text-align: center; border: 1px solid transparent; width: 100%; box-sizing: border-box; font-family: Arial, sans-serif; }
        #memorizeModeUI .memorize-sentence-placeholder { width: 100%; min-height:100px; font-size: clamp(20px, 5.5vw, 30px); line-height: 1.8; text-align: left; padding: 10px; border: 1px solid #eee; background-color: #fcfcfc; border-radius: 8px; }
        .speech-status-neutral { background-color: rgba(230, 230, 230, 0.85); color: #333; border-color: #ccc; }
        .speech-status-info { background-color: #e2f3f5; color: #31708f; border-color: #bce8f1; }
        .speech-status-success { background-color: #dff0d8; color: #3c763d; border-color: #d6e9c6; font-weight: bold; }
        .speech-status-error { background-color: #f2dede; color: #a94442; border-color: #ebccd1; font-weight: bold; }
        #audioPlayerListen, #audioPlayerTranslation, #audioPlayerSyllableFullWord, #audioPlayerSyllablePart { display: none; }
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; opacity: 0; z-index: 1000; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .btn-pulsing { animation: pulse-glow-red 1.5s infinite alternate; }
        @keyframes pulse-glow-red { 0% { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15), 0 0 0 0px rgba(255, 0, 0, 0.7); } 100% { box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25), 0 0 0 12px rgba(255, 0, 0, 0); } }
        #syllableWordDisplay { text-align: center; margin-top: 20px; } 
        #syllableWordDisplay .current-word-container { margin-bottom: 15px; padding: 20px 15px 10px; background-color: rgba(230, 240, 255, 0.7); border-radius: 10px; border: 1px solid #cce4ff; }
        #syllableWordDisplay .syllables-visual-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0px 5px; margin-bottom: 15px; font-size: 2.5em; color: #0056b3; font-weight: bold; cursor: pointer; padding: 10px; border-radius: 8px; background-color: rgba(255,255,255,0.5); transition: background-color 0.2s; }
        #syllableWordDisplay .syllables-visual-container:hover { background-color: rgba(220,235,255,0.8); }
        #syllableWordDisplay .syllables-visual-container .full-word-audio-icon { font-size: 0.7em; margin-right: 15px; cursor: pointer; }
        #syllableWordDisplay .syllable-item-text-separator { margin: 0 2px; color: #558bcc; font-weight:normal; }
        #syllableWordDisplay .syllable-parts-audio-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 15px; margin-bottom: 15px; }
        #syllableWordDisplay .syllable-audio-button { font-family: Arial, sans-serif; font-size: 1.1em; padding: 8px 15px; background-color: #007BFF; color: white; border: none; border-radius: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; }
        #syllableWordDisplay .syllable-audio-button:hover { background-color: #0056b3; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        #syllableWordDisplay .syllable-audio-button .syllable-text-on-button { font-size: 1.3em; vertical-align: middle; margin-left: 5px; }
        #syllableWordDisplay .syllable-word-translation { font-family: Arial, sans-serif; font-size: 1.1em; color: #a94442; margin-top: 10px; padding: 8px; background-color: rgba(255,255,255,0.6); border-radius: 6px; text-align: center; direction: ltr; }
        #fullscreenBtn { position: fixed; top: 20px; right: 20px; z-index: 1001; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 50px; width: 45px; height: 45px; font-size: 22px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        #fullscreenBtn:hover { transform: scale(1.1); background-color: #667eea; color: white; }

        @media (max-width: 768px) { 
            body { padding: 15px; } .page-content-wrapper { padding: 0; } 
            h1.surah-title { font-size: 2em; margin-bottom: 20px; } 
            #modeSelector, #listenModeUI, #translationModeUI, #memorizeModeUI, #syllableModeUI, #sentence { padding: 15px; border-radius:12px; } 
            #modeSelector { flex-direction: column; gap: 10px; padding: 20px; } 
            .mode-select-button { font-size: 1.1em; padding: 12px 20px; width: 100%; max-width: 280px; margin: 0 auto; } 
            .controls button { font-size: 1em; padding: 10px 18px; min-width: 110px; } 
            #listenControls #playPauseButtonListen, #translationControls #playPauseButtonTranslation { font-size: 1.2em; } 
            #sentence, #memorizeModeUI .memorize-sentence-placeholder { font-size: 24px; } 
            #memorizeTimerDisplay { font-size: 2em; } 
            #speechStatusMemorize {font-size: 1.4em;} 
            #syllableWordDisplay .syllables-visual-container { font-size: 2em; } 
            #syllableWordDisplay .syllable-audio-button { font-size: 1em; } 
            #syllableWordDisplay .syllable-word-translation { font-size: 1em; }
        }
        @media (max-width: 480px) { 
            body { padding: 10px; } 
            h1.surah-title { font-size: 1.7em; } 
            #modeSelector, #listenModeUI, #translationModeUI, #memorizeModeUI, #syllableModeUI, #sentence { padding: 12px; border-radius:10px;} 
            .mode-select-button { font-size: 1em; padding: 10px 15px; } 
            .controls button { font-size: 0.9em; padding: 8px 15px; min-width: auto; } 
            #listenControls #playPauseButtonListen, #translationControls #playPauseButtonTranslation { font-size: 1.1em; } 
            #sentence, #memorizeModeUI .memorize-sentence-placeholder { font-size: 19px; } 
            #memorizeTimerDisplay { font-size: 1.8em; } 
            #speechStatusMemorize { font-size: 1.2em; padding: 12px 20px; } 
            #syllableWordDisplay .syllables-visual-container { font-size: 1.7em; } 
            #syllableWordDisplay .syllable-audio-button { font-size: 0.9em; padding: 6px 12px; } 
            #syllableWordDisplay .syllable-word-translation { font-size: 0.9em; }
            #fullscreenBtn { top: 10px; right: 10px; width: 40px; height: 40px; font-size: 20px; }
        }
    </style>
</head>
<body class="">
 <button id="fullscreenBtn" title="Toggle Fullscreen">‚õ∂</button>
 <div class="page-content-wrapper">
    <h1 class="surah-title">lecture des texte</h1>
    <div id="modeSelector">
        <button id="btnSelectListen" class="mode-select-button">üéµ ÿßÿ≥ÿ™ŸÖÿßÿπ</button>
        <button id="btnSelectTranslation" class="mode-select-button">üìñ ÿßÿ≥ÿ™ŸÖÿßÿπ ŸÖÿπ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©</button>
        <button id="btnSelectSyllable" class="mode-select-button">üß© ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÇÿ∑ÿπŸäÿ©</button>
        <button id="btnSelectMemorize" class="mode-select-button">üé§ ŸÇÿ±ÿßÿ°ÿ©</button> 
    </div>
    <div id="listenModeUI" style="display: none;">
        <div class="lesson-title-display">le gardien du zoo</div>
        <audio id="audioPlayerListen"></audio>
        <div class="controls" id="listenControls"><button id="playPauseButtonListen" class="btn-pulsing">‚ñ∂Ô∏è</button></div>
    </div>
    <div id="translationModeUI" style="display: none;">
        <div class="lesson-title-display">le gardien du zoo</div>
        <audio id="audioPlayerTranslation"></audio>
        <div class="controls" id="translationControls"><button id="playPauseButtonTranslation" class="btn-pulsing">‚ñ∂Ô∏è</button></div>
    </div>
    <div id="memorizeModeUI" style="display: none;">
        <div id="memorizeTimerDisplay">--:--</div>
        <div class="controls" id="memorizeControls">
            <button id="speechButtonMemorize" class="btn-pulsing">üé§ ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ÿØÿ´</button>
            <button id="resetButtonMemorize">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</button>
        </div>
        <div id="showFirstWordToggleDiv">
            <input type="checkbox" id="showFirstWordToggle" checked style="vertical-align: middle;">
            <label for="showFirstWordToggle" style="vertical-align: middle; cursor:pointer;">ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ£ŸàŸÑŸâ</label>
        </div>
        <div id="speechStatusMemorize" class="speech-status-neutral">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿßÿ®ÿØÿ£" Ÿàÿ™ÿ≠ÿØÿ´</div>
        <div class="memorize-sentence-placeholder"></div>
    </div>
    <div id="syllableModeUI" style="display: none;">
        <div class="lesson-title-display">le gardien du zoo</div>
        <div id="syllableWordDisplayContainer"><div id="syllableWordDisplay"></div></div>
        <audio id="audioPlayerSyllableFullWord"></audio><audio id="audioPlayerSyllablePart"></audio>
        <div class="controls" id="syllableNavControls" style="margin-top: 20px;"><button id="prevSyllableWordButton">ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©</button><button id="nextSyllableWordButton">ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©</button></div>
    </div>
    <div id="sentence" style="display: none;"></div>
 </div>
<script>
    const SCRIPT_READERS_DATA = [
    {
        "name": "le gardien du zoo",
        "audioFile": "farid.mp3",
        "timerDuration": 60,
        "ayatTimings": [
            {
                "type": "word",
                "text": "aujourd'hui",
                "time": "0.28",
                "translation": "ÿßŸÑŸäŸàŸÖ"
            },
            {
                "type": "ayah",
                "text": ","
            },
            {
                "type": "word",
                "text": "Farid",
                "time": "0.91",
                "translation": "ŸÅÿ±ŸäÿØ",
                "isSyllableLectureEnabled": true,
                "fullWordAudio": "farid.mp3",
                "syllables": [
                    {
                        "text": "fa",
                        "audio": "farid.mp3"
                    },
                    {
                        "text": "rid",
                        "audio": "farid.mp3"
                    }
                ]
            },
            {
                "type": "word",
                "text": "ne",
                "time": "1.21",
                "translation": "ŸÑÿß",
                "isSyllableLectureEnabled": true,
                "fullWordAudio": "farid.mp3",
                "syllables": [
                    {
                        "text": "ne",
                        "audio": "farid.mp3"
                    }
                ]
            },
            {
                "type": "word",
                "text": "peut",
                "time": "1.43",
                "translation": "Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ"
            },
            {
                "type": "word",
                "text": "pas",
                "time": "1.65",
                "translation": "ŸÑÿß"
            },
            {
                "type": "word",
                "text": "aller",
                "time": "2.0",
                "translation": "Ÿäÿ∞Ÿáÿ®"
            },
            {
                "type": "word",
                "text": "√†",
                "time": "2.13",
                "translation": "ÿ•ŸÑŸâ"
            },
            {
                "type": "word",
                "text": "la",
                "time": "2.32",
                "translation": "ÿßŸÑŸÄ"
            },
            {
                "type": "word",
                "text": "piscine",
                "time": "2.86",
                "translation": "ÿßŸÑŸÖÿ≥ÿ®ÿ≠"
            },
            {
                "type": "ayah",
                "text": "."
            },
            {
                "type": "word",
                "text": "il",
                "time": "3.64",
                "translation": "ŸáŸà"
            },
            {
                "type": "word",
                "text": "a",
                "time": "3.83",
                "translation": "ŸÑÿØŸäŸá"
            },
            {
                "type": "word",
                "text": "mal",
                "time": "4.14",
                "translation": "ÿ£ŸÑŸÖ"
            },
            {
                "type": "word",
                "text": "√†",
                "time": "4.31",
                "translation": "ŸÅŸä"
            },
            {
                "type": "word",
                "text": "l'oreille",
                "time": "4.85",
                "translation": "ÿßŸÑÿ£ÿ∞ŸÜ"
            },
            {
                "type": "ayah",
                "text": "."
            },
            {
                "type": "word",
                "text": "les",
                "time": "5.73",
                "translation": "ÿßŸÑŸÄ"
            },
            {
                "type": "word",
                "text": "enfants",
                "time": "6.05",
                "translation": "ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ"
            },
            {
                "type": "word",
                "text": "du",
                "time": "6.27",
                "translation": "ŸÖŸÜ ÿßŸÑŸÄ"
            },
            {
                "type": "word",
                "text": "quartier",
                "time": "6.87",
                "translation": "ÿßŸÑÿ≠Ÿä"
            },
            {
                "type": "word",
                "text": "ont",
                "time": "7.24",
                "translation": "ŸÑÿØŸäŸáŸÖ"
            },
            {
                "type": "word",
                "text": "une",
                "time": "7.54",
                "translation": "Ÿàÿßÿ≠ÿØÿ©"
            },
            {
                "type": "word",
                "text": "comp√©tition",
                "time": "8.47",
                "translation": "ŸÖÿ≥ÿßÿ®ŸÇÿ©"
            },
            {
                "type": "ayah",
                "text": "."
            },
            {
                "type": "word",
                "text": "maman",
                "time": "9.39",
                "translation": "ÿßŸÑÿ£ŸÖ"
            },
            {
                "type": "word",
                "text": "donne",
                "time": "9.77",
                "translation": "ÿ™ÿπÿ∑Ÿä"
            },
            {
                "type": "word",
                "text": "√†",
                "time": "9.94",
                "translation": "ŸÑŸÄŸê"
            },
            {
                "type": "word",
                "text": "Farid",
                "time": "10.38",
                "translation": "ŸÅÿ±ŸäÿØ"
            },
            {
                "type": "word",
                "text": "de",
                "time": "10.67",
                "translation": "ŸÖŸÜ"
            },
            {
                "type": "word",
                "text": "la",
                "time": "10.82",
                "translation": "ÿßŸÑŸÄ"
            },
            {
                "type": "word",
                "text": "p√¢te",
                "time": "11.15",
                "translation": "ÿπÿ¨ŸäŸÜÿ©"
            },
            {
                "type": "word",
                "text": "√†",
                "time": "11.34",
                "translation": "ŸÑŸÄŸê"
            },
            {
                "type": "word",
                "text": "modeler",
                "time": "11.99",
                "translation": "ÿßŸÑÿ™ÿ¥ŸÉŸäŸÑ"
            },
            {
                "type": "word",
                "text": "et",
                "time": "12.33",
                "translation": "Ÿà"
            },
            {
                "type": "word",
                "text": "un",
                "time": "12.54",
                "translation": "Ÿàÿßÿ≠ÿØ"
            },
            {
                "type": "word",
                "text": "livre",
                "time": "12.9",
                "translation": "ŸÉÿ™ÿßÿ®"
            },
            {
                "type": "word",
                "text": "d'images",
                "time": "13.4",
                "translation": "ÿµŸàÿ±"
            },
            {
                "type": "word",
                "text": "√†",
                "time": "13.73",
                "translation": "ŸÑŸÄŸê"
            },
            {
                "type": "word",
                "text": "colorier",
                "time": "14.46",
                "translation": "ŸäŸÑŸàŸÜ"
            },
            {
                "type": "ayah",
                "text": "."
            }
        ]
    }
];
    const isSingleLesson = SCRIPT_READERS_DATA.length === 1;
    const bodyElement = document.body;
    const btnSelectListen = document.getElementById('btnSelectListen');
    const btnSelectTranslation = document.getElementById('btnSelectTranslation');
    const btnSelectMemorize = document.getElementById('btnSelectMemorize');
    const btnSelectSyllable = document.getElementById('btnSelectSyllable');
    const listenModeUI = document.getElementById('listenModeUI');
    const translationModeUI = document.getElementById('translationModeUI');
    const memorizeModeUI = document.getElementById('memorizeModeUI');
    const syllableModeUI = document.getElementById('syllableModeUI');
    const sentenceContainerShared = document.getElementById('sentence'); 
    const readerSelectListen = document.getElementById('readerSelectListen');
    const readerSelectTranslation = document.getElementById('readerSelectTranslation');
    const readerSelectSyllable = document.getElementById('readerSelectSyllable'); 
    const memorizeSentencePlaceholder = memorizeModeUI.querySelector('.memorize-sentence-placeholder');
    let allWordSpansShared = [], timedWordsForHighlight = [];
    let currentActiveMode = null;
    let currentReaderDataForMode = null; 
    let lastScrolledWord = null;

    if (!isSingleLesson) {
        SCRIPT_READERS_DATA.forEach((reader, index) => {
            const option = document.createElement('option');
            option.value = index; option.textContent = reader.name;
            if(readerSelectListen) readerSelectListen.appendChild(option.cloneNode(true));
            if(readerSelectTranslation) readerSelectTranslation.appendChild(option.cloneNode(true));
            if(readerSelectSyllable) readerSelectSyllable.appendChild(option.cloneNode(true));
        });
    }

    function generateSentenceSpans(readerData) {
        sentenceContainerShared.innerHTML = ''; 
        const createWordElement = (item) => {
            const wordWrapper = document.createElement('span');
            wordWrapper.classList.add('word-wrapper');
            if (item.time) wordWrapper.dataset.time = item.time;
            const translationSpan = document.createElement('span');
            translationSpan.classList.add('translation-text');
            if (item.translation) { translationSpan.textContent = item.translation; }
            wordWrapper.appendChild(translationSpan);
            const arabicSpan = document.createElement('span');
            arabicSpan.classList.add('arabic-word');
            arabicSpan.textContent = item.text;
            wordWrapper.appendChild(arabicSpan);
            return wordWrapper;
        };
        (readerData.ayatTimings || []).forEach(item => {
            if (item.type === 'word') {
                sentenceContainerShared.appendChild(createWordElement(item));
            } else { 
                const ayahSpan = document.createElement('span');
                ayahSpan.classList.add('ayah-number');
                ayahSpan.textContent = item.text;
                sentenceContainerShared.appendChild(ayahSpan);
            }
        });
        allWordSpansShared = Array.from(sentenceContainerShared.querySelectorAll('.word-wrapper'));
        timedWordsForHighlight = Array.from(sentenceContainerShared.querySelectorAll('.word-wrapper[data-time]'));
    }

    function resetAllWordStyles(spansToReset = null) {
        const targetSpans = spansToReset || allWordSpansShared; 
        targetSpans.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word');
            const sign = span.querySelector('.correct-sign');
            if (sign) sign.remove();
        });
        lastScrolledWord = null;
    }

    const audioPlayerListen = document.getElementById("audioPlayerListen");
    const playPauseButtonListen = document.getElementById("playPauseButtonListen");
    let listen_isPaused = false, listen_audioWasEnded = false;
    const audioPlayerTranslation = document.getElementById("audioPlayerTranslation");
    const playPauseButtonTranslation = document.getElementById("playPauseButtonTranslation");
    let translation_isPaused = false, translation_audioWasEnded = false;

    function common_highlightWords(audioPlayer, wordWrappersArray, isPaused, audioWasEnded) {
        if (isPaused || audioWasEnded) return; 
        const currentTime = audioPlayer.currentTime;
        let activeWordFound = false;
        wordWrappersArray.forEach((wrapper, index) => {
            let wordTime = parseFloat(wrapper.dataset.time);
            let nextWrapper = wordWrappersArray.find((w, i) => i > index && w.dataset.time);
            let endTime = nextWrapper ? parseFloat(nextWrapper.dataset.time) : (audioPlayer.duration || Infinity);

            if (!activeWordFound && currentTime >= wordTime && currentTime < endTime) {
                activeWordFound = true;
                wrapper.classList.add("highlight-active-word");
                wrapper.classList.remove("processed-word");
                if(wrapper !== lastScrolledWord){
                    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                    lastScrolledWord = wrapper;
                }
            } else {
                wrapper.classList.remove("highlight-active-word");
                if (currentTime >= endTime) wrapper.classList.add("processed-word");
                else wrapper.classList.remove("processed-word");
            }
        });
    }

    function setupAudioMode(mode, readerIndex) {
        const isListenMode = mode === 'listen';
        const audioPlayer = isListenMode ? audioPlayerListen : audioPlayerTranslation;
        const playPauseButton = isListenMode ? playPauseButtonListen : playPauseButtonTranslation;
        
        currentReaderDataForMode = SCRIPT_READERS_DATA[readerIndex];
        if (!currentReaderDataForMode) return;
        
        lastScrolledWord = null;
        audioPlayer.src = currentReaderDataForMode.audioFile;
        audioPlayer.currentTime = 0;
        audioPlayer.pause();
        
        if(isListenMode) { listen_isPaused = true; listen_audioWasEnded = false; }
        else { translation_isPaused = true; translation_audioWasEnded = false; }
        
        playPauseButton.textContent = "‚ñ∂Ô∏è";
        playPauseButton.classList.add('btn-pulsing');
        generateSentenceSpans(currentReaderDataForMode);
        resetAllWordStyles();
        
        timedWordsForHighlight.forEach(wrapper => { 
            wrapper.onclick = function() {
                if (isListenMode ? listen_audioWasEnded : translation_audioWasEnded) { 
                    resetAllWordStyles(timedWordsForHighlight); 
                    if(isListenMode) listen_audioWasEnded = false; else translation_audioWasEnded = false;
                    playPauseButton.classList.add('btn-pulsing');
                }
                audioPlayer.currentTime = parseFloat(this.dataset.time);
                if (audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.error("Audio play failed:", e));
                }
            };
        });

        playPauseButton.onclick = () => {
            let wasEnded = isListenMode ? listen_audioWasEnded : translation_audioWasEnded;
            if(wasEnded) {
                audioPlayer.currentTime = 0;
                resetAllWordStyles(timedWordsForHighlight);
                if(isListenMode) listen_audioWasEnded = false; else translation_audioWasEnded = false;
            }
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.error("Audio play failed:", e));
            } else {
                audioPlayer.pause();
            }
        };

        audioPlayer.onplay = () => { playPauseButton.textContent = "‚è∏Ô∏è"; playPauseButton.classList.remove('btn-pulsing'); if(isListenMode) listen_isPaused = false; else translation_isPaused = false; };
        audioPlayer.onpause = () => { playPauseButton.textContent = "‚ñ∂Ô∏è"; if(!(isListenMode ? listen_audioWasEnded : translation_audioWasEnded)) playPauseButton.classList.add('btn-pulsing'); if(isListenMode) listen_isPaused = true; else translation_isPaused = true; };
        audioPlayer.ontimeupdate = () => common_highlightWords(audioPlayer, timedWordsForHighlight, isListenMode ? listen_isPaused : translation_isPaused, isListenMode ? listen_audioWasEnded : translation_audioWasEnded);
        audioPlayer.onended = () => {
             playPauseButton.textContent = "üîÑ";
             playPauseButton.classList.add('btn-pulsing');
             if(isListenMode) { listen_isPaused = true; listen_audioWasEnded = true; } 
             else { translation_isPaused = true; translation_audioWasEnded = true; }
        };
    }
    
    function initListenMode() {
        listenModeUI.style.display = 'block'; 
        sentenceContainerShared.style.display = 'block';
        bodyElement.classList.remove('page-translation-mode-active');
        if (isSingleLesson) {
            setupAudioMode('listen', 0);
        } else {
            setupAudioMode('listen', readerSelectListen.value || 0);
            readerSelectListen.onchange = (e) => setupAudioMode('listen', e.target.value);
        }
    }
    function deactivateListenMode() { if (!audioPlayerListen.paused) audioPlayerListen.pause(); listenModeUI.style.display = 'none'; }
    
    function initTranslationMode() {
        translationModeUI.style.display = 'block'; 
        sentenceContainerShared.style.display = 'block';
        bodyElement.classList.add('page-translation-mode-active');
        if (isSingleLesson) {
            setupAudioMode('translation', 0);
        } else {
            setupAudioMode('translation', readerSelectTranslation.value || 0);
            readerSelectTranslation.onchange = (e) => setupAudioMode('translation', e.target.value);
        }
    }
    function deactivateTranslationMode() { if (!audioPlayerTranslation.paused) audioPlayerTranslation.pause(); translationModeUI.style.display = 'none'; }
    
    const memorize_speechButton = document.getElementById("speechButtonMemorize");
    const memorize_resetButton = document.getElementById("resetButtonMemorize");
    const memorize_timerDisplay = document.getElementById("memorizeTimerDisplay");
    const memorize_showFirstWordToggle = document.getElementById('showFirstWordToggle');
    const memorize_speechStatus = document.getElementById("speechStatusMemorize");
    
    let memorize_currentWordIndex = 0, memorize_isRecognizing = false;
    let memorize_recognition;
    let memorize_timerIntervalId = null, memorize_timerRemainingSeconds = 0, memorize_startTime = null;
    let memorize_wordSpans = [], memorize_wordDataObjects = [];
    
    function normalizeFrenchText(text) {
        if (!text) return "";
        return text.trim().toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[.,'‚Äô\/#!$%\^&\*;:{}=\-_\`~()?]/g, "");
    }

    function triggerConfettiEffect() { const c=100;for(let i=0;i<c;i++){const e=document.createElement("div");e.classList.add("confetti"),e.style.left=100*Math.random()+"vw",e.style.backgroundColor=["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800"][Math.floor(15*Math.random())],e.style.animationDelay=.5*Math.random()+"s",document.body.appendChild(e),setTimeout(()=>{e.remove()},3500)}}

    function memorize_updateTimerDisplay(seconds) {
        const minutes = Math.floor(seconds / 60); 
        const secs = seconds % 60; 
        memorize_timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; 
    }
    function memorize_startTimer() {
        if (!currentReaderDataForMode || currentReaderDataForMode.timerDuration <= 0) { memorize_startTime = Date.now(); return; }
        memorize_timerRemainingSeconds = currentReaderDataForMode.timerDuration;
        memorize_updateTimerDisplay(memorize_timerRemainingSeconds);
        memorize_startTime = Date.now();
        if (memorize_timerIntervalId) clearInterval(memorize_timerIntervalId);
        memorize_timerIntervalId = setInterval(() => {
            memorize_timerRemainingSeconds--;
            memorize_updateTimerDisplay(memorize_timerRemainingSeconds);
            if (memorize_timerRemainingSeconds <= 0) {
                clearInterval(memorize_timerIntervalId);
                memorize_speechStatus.textContent = "ÿßŸÑŸàŸÇÿ™ ÿßŸÜÿ™ŸáŸâ! ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ.";
                memorize_speechStatus.className = 'speech-status-error';
                if (memorize_isRecognizing) memorize_recognition.stop();
            }
        }, 1000);
    }
    function memorize_stopTimer() { if (memorize_timerIntervalId) clearInterval(memorize_timerIntervalId); }

    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognitionAPI) {
        memorize_recognition = new SpeechRecognitionAPI();
        memorize_recognition.continuous = true;
        memorize_recognition.interimResults = true;
        memorize_recognition.lang = 'fr-FR';

        memorize_recognition.onstart = () => { memorize_isRecognizing = true; memorize_speechButton.textContent = "üî¥ ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ÿ¨ÿßÿ±Ÿç..."; memorize_speechButton.classList.add('listening'); memorize_speechStatus.textContent = "ÿ™ÿ≠ÿØÿ´ ÿßŸÑÿ¢ŸÜ..."; memorize_speechStatus.className = 'speech-status-info'; };
        memorize_recognition.onend = () => { memorize_isRecognizing = false; memorize_speechButton.textContent = "üé§ ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ÿØÿ´"; memorize_speechButton.classList.remove('listening'); if (memorize_currentWordIndex > 0 && memorize_currentWordIndex < memorize_wordSpans.length) { memorize_speechStatus.textContent = "ÿ™ŸàŸÇŸÅ ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ. ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ©."; memorize_speechStatus.className = 'speech-status-info'; } };
        memorize_recognition.onerror = (event) => { memorize_speechStatus.textContent = "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿπÿ±ŸÅ: " + event.error; memorize_speechStatus.className = 'speech-status-error'; };

        memorize_recognition.onresult = (event) => {
            let finalTranscript = '';
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            if(interimTranscript) memorize_speechStatus.textContent = interimTranscript;
            
            const wordsToProcess = finalTranscript.trim().split(/\s+/).filter(Boolean);
            
            for (let spokenWord of wordsToProcess) {
                if (memorize_currentWordIndex >= memorize_wordSpans.length) break;

                const normalizedSpoken = normalizeFrenchText(spokenWord);
                const targetData = memorize_wordDataObjects[memorize_currentWordIndex];
                
                const validForms = [normalizeFrenchText(targetData.text), ...(targetData.alternatives || []).map(alt => normalizeFrenchText(alt))];

                if (validForms.includes(normalizedSpoken)) {
                    const targetWrapper = memorize_wordSpans[memorize_currentWordIndex];
                    targetWrapper.classList.remove('highlight-active-word');
                    targetWrapper.classList.add('processed-word');
                    if (!targetWrapper.querySelector('.correct-sign')) {
                        const sign = document.createElement('span'); sign.className = 'correct-sign'; sign.textContent = '‚úì';
                        targetWrapper.appendChild(sign);
                    }
                    memorize_currentWordIndex++;
                    memorize_speechStatus.textContent = "ŸÖŸÖÿ™ÿßÿ≤! " + targetData.text;
                    memorize_speechStatus.className = 'speech-status-success';
                } else {
                    const isRepetition = memorize_currentWordIndex > 0 && [normalizeFrenchText(memorize_wordDataObjects[memorize_currentWordIndex-1].text), ...((memorize_wordDataObjects[memorize_currentWordIndex-1].alternatives || []).map(alt => normalizeFrenchText(alt)))].includes(normalizedSpoken);
                    if(isRepetition) {
                        continue; 
                    }
                    memorize_speechStatus.textContent = `ÿ≥ŸÖÿπÿ™ "${spokenWord}". ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`;
                    memorize_speechStatus.className = 'speech-status-error';
                    break;
                }
            }

            if (memorize_currentWordIndex < memorize_wordSpans.length && memorize_showFirstWordToggle.checked) {
                memorize_wordSpans[memorize_currentWordIndex].classList.add('highlight-active-word');
            }

            if (memorize_currentWordIndex >= memorize_wordSpans.length) {
                memorize_stopTimer();
                let timeSpentMsg = "";
                if (memorize_startTime) {
                    const timeSpentSeconds = Math.round((Date.now() - memorize_startTime) / 1000);
                    timeSpentMsg = ` ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ${timeSpentSeconds} ÿ´ÿßŸÜŸäÿ©.`;
                }
                memorize_speechStatus.textContent = `üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™!${timeSpentMsg} üéâ`;
                memorize_speechStatus.className = 'speech-status-success';
                triggerConfettiEffect();
                if(memorize_isRecognizing) memorize_recognition.stop();
            }
        };
    }

    function memorize_toggleSpeechRecognition() {
        if (!SpeechRecognitionAPI) return;
        if (memorize_isRecognizing) {
            memorize_recognition.stop();
            memorize_stopTimer();
        } else {
            if (memorize_currentWordIndex >= memorize_wordSpans.length || (currentReaderDataForMode.timerDuration > 0 && memorize_timerRemainingSeconds <= 0)) {
                memorize_resetActivity();
            }
            try {
                memorize_recognition.start();
                memorize_startTimer();
            } catch(e) {
                memorize_speechStatus.textContent = "ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ÿØÿ° ÿßŸÑÿ™ÿπÿ±ŸÅ.";
                memorize_speechStatus.className = 'speech-status-error';
            }
        }
    }
    
    function memorize_resetActivity() {
        memorize_stopTimer();
        memorize_currentWordIndex = 0;
        memorize_startTime = null;
        resetAllWordStyles(memorize_wordSpans);
        if (memorize_showFirstWordToggle.checked && memorize_wordSpans.length > 0) {
            memorize_wordSpans[0].classList.add('highlight-active-word');
        }
        memorize_speechStatus.textContent = "ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ \"ÿßÿ®ÿØÿ£\" Ÿàÿ™ÿ≠ÿØÿ´";
        memorize_speechStatus.className = 'speech-status-neutral';
        memorize_updateTimerDisplay(currentReaderDataForMode ? currentReaderDataForMode.timerDuration : 0);
    }
    
    function initMemorizeMode() {
        memorizeModeUI.style.display = 'block';
        sentenceContainerShared.style.display = 'none';
        memorizeSentencePlaceholder.classList.add('memorize-mode-active');
        
        const readerIndex = isSingleLesson ? 0 : (readerSelectListen.value || 0);
        currentReaderDataForMode = SCRIPT_READERS_DATA[readerIndex];
        if (!currentReaderDataForMode) return;
        
        generateSentenceSpans(currentReaderDataForMode);
        memorizeSentencePlaceholder.innerHTML = sentenceContainerShared.innerHTML;
        
        memorize_wordDataObjects = currentReaderDataForMode.ayatTimings.filter(item => item.type === 'word');
        memorize_wordSpans = Array.from(memorizeSentencePlaceholder.querySelectorAll('.word-wrapper'));
        
        if (!SpeechRecognitionAPI) { memorize_speechButton.disabled = true; memorize_speechStatus.textContent = "ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ™ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ."; return; }
        
        memorize_resetActivity();
        memorize_speechButton.onclick = memorize_toggleSpeechRecognition;
        memorize_resetButton.onclick = memorize_resetActivity;
        memorize_showFirstWordToggle.onchange = () => {
             if (memorize_currentWordIndex < memorize_wordSpans.length) {
                 const currentWord = memorize_wordSpans[memorize_currentWordIndex];
                 if(memorize_showFirstWordToggle.checked && !currentWord.classList.contains('processed-word')) {
                    currentWord.classList.add('highlight-active-word');
                 } else {
                    currentWord.classList.remove('highlight-active-word');
                 }
             }
        };
    }
    function deactivateMemorizeMode() { if (SpeechRecognitionAPI && memorize_isRecognizing) memorize_recognition.stop(); memorize_stopTimer(); memorizeModeUI.style.display = 'none'; }
    
    const syllableWordDisplay = document.getElementById('syllableWordDisplay');
    const audioPlayerSyllableFullWord = document.getElementById('audioPlayerSyllableFullWord');
    const audioPlayerSyllablePart = document.getElementById('audioPlayerSyllablePart');
    const prevSyllableWordButton = document.getElementById('prevSyllableWordButton');
    const nextSyllableWordButton = document.getElementById('nextSyllableWordButton');
    let syllable_lectureWords = [];
    let syllable_currentWordIndex = 0;

    function playSyllableAudio(player, src) {
        audioPlayerSyllableFullWord.pause();
        audioPlayerSyllablePart.pause();
        player.src = src;
        player.play().catch(e => console.error("Syllable audio play error:", e));
    }

    function syllable_displayCurrentWord() {
        syllableWordDisplay.innerHTML = ''; 
        if (syllable_lectureWords.length === 0) {
            syllableWordDisplay.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©.</p>';
            return;
        }
        const wordData = syllable_lectureWords[syllable_currentWordIndex];
        const wordContainer = document.createElement('div');
        wordContainer.classList.add('current-word-container');
        const syllablesVisualContainer = document.createElement('div');
        syllablesVisualContainer.classList.add('syllables-visual-container');
        
        const fullWordAudioIcon = document.createElement('span');
        fullWordAudioIcon.textContent = 'üîä';
        fullWordAudioIcon.classList.add('full-word-audio-icon');
        fullWordAudioIcon.onclick = (e) => { e.stopPropagation(); if (wordData.fullWordAudio) playSyllableAudio(audioPlayerSyllableFullWord, wordData.fullWordAudio); };
        syllablesVisualContainer.appendChild(fullWordAudioIcon);

        wordData.syllables.forEach((syll, index) => {
            const syllTextSpan = document.createElement('span');
            syllTextSpan.textContent = syll.text;
            syllablesVisualContainer.appendChild(syllTextSpan);
            if (index < wordData.syllables.length - 1) {
                const separator = document.createElement('span'); separator.textContent = " - "; 
                syllablesVisualContainer.appendChild(separator);
            }
        });
        
        syllablesVisualContainer.onclick = () => { if (wordData.fullWordAudio) playSyllableAudio(audioPlayerSyllableFullWord, wordData.fullWordAudio); };
        wordContainer.appendChild(syllablesVisualContainer);

        const syllablePartsAudioContainer = document.createElement('div');
        syllablePartsAudioContainer.classList.add('syllable-parts-audio-container');
        wordData.syllables.forEach(syll => {
            const syllAudioButton = document.createElement('button');
            syllAudioButton.classList.add('syllable-audio-button');
            syllAudioButton.innerHTML = `üîä <span class="syllable-text-on-button">${syll.text}</span>`;
            syllAudioButton.onclick = () => { playSyllableAudio(audioPlayerSyllablePart, syll.audio); };
            syllablePartsAudioContainer.appendChild(syllAudioButton);
        });
        wordContainer.appendChild(syllablePartsAudioContainer);
        if (wordData.translation) {
            const translationDiv = document.createElement('div');
            translationDiv.classList.add('syllable-word-translation');
            translationDiv.textContent = wordData.translation;
            wordContainer.appendChild(translationDiv);
        }
        syllableWordDisplay.appendChild(wordContainer);
        prevSyllableWordButton.disabled = syllable_currentWordIndex === 0;
        nextSyllableWordButton.disabled = syllable_currentWordIndex >= syllable_lectureWords.length - 1;
    }
    
    function setupSyllableModeForReader(readerIndex) {
        currentReaderDataForMode = SCRIPT_READERS_DATA[readerIndex];
        syllable_lectureWords = (currentReaderDataForMode.ayatTimings || []).filter(item => item.isSyllableLectureEnabled);
        syllable_currentWordIndex = 0;
        syllable_displayCurrentWord();
    }

    function initSyllableMode() {
        syllableModeUI.style.display = 'block';
        if (isSingleLesson) {
            setupSyllableModeForReader(0);
        } else {
            setupSyllableModeForReader(readerSelectSyllable.value || 0);
            readerSelectSyllable.onchange = (e) => setupSyllableModeForReader(e.target.value);
        }
        prevSyllableWordButton.onclick = () => { 
            audioPlayerSyllableFullWord.pause(); 
            audioPlayerSyllablePart.pause();
            if (syllable_currentWordIndex > 0) { 
                syllable_currentWordIndex--; 
                syllable_displayCurrentWord(); 
            } 
        };
        nextSyllableWordButton.onclick = () => { 
            audioPlayerSyllableFullWord.pause(); 
            audioPlayerSyllablePart.pause();
            if (syllable_currentWordIndex < syllable_lectureWords.length - 1) { 
                syllable_currentWordIndex++; 
                syllable_displayCurrentWord(); 
            } 
        };
    }
    function deactivateSyllableMode() {
        audioPlayerSyllableFullWord.pause();
        audioPlayerSyllablePart.pause();
        syllableModeUI.style.display = 'none';
    }
    
    function switchToMode(mode) {
        if (currentActiveMode) {
            if (currentActiveMode === 'listen') deactivateListenMode();
            else if (currentActiveMode === 'translation') deactivateTranslationMode();
            else if (currentActiveMode === 'memorize') deactivateMemorizeMode();
            else if (currentActiveMode === 'syllable') deactivateSyllableMode();
        }
        
        document.querySelectorAll('.mode-select-button').forEach(b => b.classList.remove('active'));
        [listenModeUI, translationModeUI, memorizeModeUI, syllableModeUI].forEach(ui => ui.style.display = 'none');
        sentenceContainerShared.innerHTML = '';
        memorizeSentencePlaceholder.innerHTML = '';
        bodyElement.classList.remove('page-translation-mode-active');

        currentActiveMode = mode;
        if (mode === 'listen') { initListenMode(); btnSelectListen.classList.add('active'); }
        else if (mode === 'translation') { initTranslationMode(); btnSelectTranslation.classList.add('active'); }
        else if (mode === 'syllable') { initSyllableMode(); btnSelectSyllable.classList.add('active'); }
        else if (mode === 'memorize') { initMemorizeMode(); btnSelectMemorize.classList.add('active'); }
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    
    btnSelectListen.addEventListener('click', () => switchToMode('listen'));
    btnSelectTranslation.addEventListener('click', () => switchToMode('translation'));
    btnSelectSyllable.addEventListener('click', () => switchToMode('syllable'));
    btnSelectMemorize.addEventListener('click', () => switchToMode('memorize'));
    document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

    if (SCRIPT_READERS_DATA && SCRIPT_READERS_DATA.length > 0) {
        switchToMode('listen');
    }
</script>
</body>
</html>
